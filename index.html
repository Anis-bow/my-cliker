<script>
    const DB_URL = "https://clikercomee-default-rtdb.firebaseio.com"; 
    
    // 1. Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð´Ð°Ð½Ð½Ñ‹Ñ… (Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¾ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ñ‡Ð¸ÑÐµÐ»)
    let userName = localStorage.getItem('p_name') || prompt("Ð¢Ð²Ð¾Ð¹ Ð½Ð¸Ðº:") || "User" + Math.floor(Math.random()*100);
    localStorage.setItem('p_name', userName);
    
    let count = parseInt(localStorage.getItem('p_coins')) || 0;
    let power = parseInt(localStorage.getItem('p_power')) || 1;

    // 2. Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ ÑÐºÑ€Ð°Ð½Ð° (Ñ‚ÐµÐ¿ÐµÑ€ÑŒ Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÑ‚ Ð²ÑÑ‘ ÑÑ€Ð°Ð·Ñƒ)
    function updateUI() {
        const coinsElem = document.getElementById('coins');
        const powerElem = document.getElementById('current-power');
        const boostElem = document.getElementById('boost-label');
        const nameElem = document.getElementById('display-name');

        if(coinsElem) coinsElem.innerText = count.toLocaleString();
        if(powerElem) powerElem.innerText = power;
        if(nameElem) nameElem.innerText = userName;
        if(boostElem) boostElem.innerText = Math.pow(2, power - 1) * 100;
    }

    // 3. Ð¡Ð¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ñ Ñ Ð±Ð°Ð·Ð¾Ð¹
    async function sync() { 
        try {
            await fetch(`${DB_URL}/players/${userName}.json`, { 
                method: 'PUT', 
                body: JSON.stringify({ score: count, power: power }) 
            }); 
        } catch (e) { console.error("ÐžÑˆÐ¸Ð±ÐºÐ° Ð±Ð°Ð·Ñ‹:", e); }
    }

    // 4. Ð›Ð¾Ð³Ð¸ÐºÐ° ÐºÐ»Ð¸ÐºÐ° (Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¾ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐºÑ€Ð°Ð½Ð°)
    document.getElementById('click-btn').onclick = () => {
        count += power; 
        updateUI(); // Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÐºÑ€Ð°Ð½
        localStorage.setItem('p_coins', count); 
        sync(); // ÐŸÐ¾Ñ‚Ð¾Ð¼ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð² Ð±Ð°Ð·Ñƒ
        
        // Ð­Ñ„Ñ„ÐµÐºÑ‚ Ñ‚Ñ€ÑÑÐºÐ¸
        const btn = document.getElementById('click-btn');
        btn.classList.remove('shake-anim'); 
        void btn.offsetWidth; 
        btn.classList.add('shake-anim');
    };

    // 5. ÐŸÐ¾ÐºÑƒÐ¿ÐºÐ° Ð±ÑƒÑÑ‚Ð°
    function buyBoost() {
        let cost = Math.pow(2, power - 1) * 100;
        if (count >= cost) { 
            count -= cost; 
            power++; 
            updateUI(); 
            localStorage.setItem('p_coins', count);
            localStorage.setItem('p_power', power);
            sync(); 
        } else { 
            alert("ÐœÐ°Ð»Ð¾ Ð¼Ð¾Ð½ÐµÑ‚! ÐÑƒÐ¶Ð½Ð¾: " + cost); 
        }
    }

    // 6. Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¾ÐºÐ½Ð°Ð¼Ð¸
    function openModal(id) { 
        closeModals(); 
        document.getElementById(id).style.display = 'flex'; 
        if(id === 'modal-top') loadLB(); 
        if(id === 'modal-chat') loadChat(); 
    }

    function closeModals() { 
        document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); 
        updateUI(); // ÐžÐ‘Ð¯Ð—ÐÐ¢Ð•Ð›Ð¬ÐÐž Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÐºÑ€Ð°Ð½ Ð¿Ñ€Ð¸ Ð·Ð°ÐºÑ€Ñ‹Ñ‚Ð¸Ð¸ Ð¾ÐºÐ¾Ð½
    }

    // 7. Ð Ð°Ð±Ð¾Ñ‚Ð° Ñ Ð¢Ð°Ð±Ð»Ð¸Ñ†ÐµÐ¹ Ð›Ð¸Ð´ÐµÑ€Ð¾Ð² (Ð˜Ð³Ñ€Ð¾ÐºÐ¸)
    async function loadLB() {
        try {
            const res = await fetch(`${DB_URL}/players.json`); 
            const data = await res.json();
            const box = document.getElementById('lb-content'); 
            if(!box) return;
            box.innerHTML = '';
            
            if(!data) { box.innerHTML = "ÐÐµÑ‚ Ð¸Ð³Ñ€Ð¾ÐºÐ¾Ð²"; return; }
            
            const sorted = Object.entries(data).sort((a,b) => b[1].score - a[1].score).slice(0,10);
            sorted.forEach((p, i) => {
                box.innerHTML += `
                    <div class="player-row" style="${p[0] === userName ? 'color: #3498db; font-weight: bold;' : ''}">
                        <span>${i+1}. ${p[0]} <span class="lvl-badge">LVL ${p[1].power || 1}</span></span>
                        <b>${(p[1].score || 0).toLocaleString()} ðŸ’µ</b>
                    </div>`;
            });
        } catch (e) { console.error("ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð¢ÐžÐŸÐ°:", e); }
    }

    // Ð—Ð°Ð¿ÑƒÑÐº Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹ÑÐ° Ð¿Ñ€Ð¸ ÑÑ‚Ð°Ñ€Ñ‚Ðµ
    updateUI();

    // ÐÐ²Ñ‚Ð¾-Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ… (ÐºÐ°Ð¶Ð´Ñ‹Ðµ 3 ÑÐµÐºÑƒÐ½Ð´Ñ‹), ÐµÑÐ»Ð¸ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚Ð¾ Ð¾ÐºÐ½Ð¾ Ð»Ð¸Ð´ÐµÑ€Ð¾Ð² Ð¸Ð»Ð¸ Ñ‡Ð°Ñ‚
    setInterval(() => {
        if(document.getElementById('modal-chat').style.display === 'flex') loadChat();
        if(document.getElementById('modal-top').style.display === 'flex') loadLB();
    }, 3000);
</script>
