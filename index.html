<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>bachoi 17 maktab</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f4f8; margin: 0; display: flex; flex-direction: column; align-items: center; height: 100vh; overflow: hidden; -webkit-tap-highlight-color: transparent; }
        
        /* –ó–∞—â–∏—Ç–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ */
        img, div, span, b { -webkit-user-select: none; user-select: none; -webkit-touch-callout: none; }

        #ui-top { text-align: center; margin-top: 20px; z-index: 10; width: 100%; }
        #score-container { font-size: 3.5rem; font-weight: 900; color: #2c3e50; line-height: 1; }
        #power-info { font-size: 1rem; color: #7f8c8d; margin-top: 5px; font-weight: bold; }
        #user-info { margin-top: 10px; font-size: 0.9rem; color: #3498db; cursor: pointer; text-decoration: underline; }

        #game-area { flex: 1; display: flex; align-items: center; justify-content: center; width: 100%; }
        
        /* –ö–Ω–æ–ø–∫–∞-–≥–µ—Ä–± —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è */
        #click-btn { 
            width: 220px; height: 220px; border-radius: 50%; border: 8px solid white; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.1); cursor: pointer; object-fit: cover; 
            transition: transform 0.05s; 
            pointer-events: auto; /* –ß—Ç–æ–±—ã –∫–ª–∏–∫–∏ —Ä–∞–±–æ—Ç–∞–ª–∏ */
        }
        
        @keyframes shake { 0% { transform: scale(1); } 50% { transform: scale(0.92); } 100% { transform: scale(1); } }
        .shake-anim { animation: shake 0.1s; }

        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 100; backdrop-filter: blur(4px); }
        .modal-content { background: white; width: 92%; max-width: 400px; border-radius: 25px; padding: 20px; position: relative; height: 70vh; display: flex; flex-direction: column; }
        .close-btn { position: absolute; top: 15px; right: 20px; font-size: 1.8rem; cursor: pointer; color: #ccc; z-index: 10; }
        
        #chat-content, #lb-content { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 8px; background: #f8f9fa; border-radius: 15px; border: 1px solid #eee; }
        .player-row { display: flex; justify-content: space-between; padding: 10px; background: white; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.03); }

        .msg { background: #fff; padding: 8px 12px; border-radius: 15px; align-self: flex-start; max-width: 85%; }
        .msg.my { background: #3498db; color: white; align-self: flex-end; }

        nav { position: fixed; bottom: 0; width: 100%; height: 75px; background: white; display: flex; border-top: 1px solid #eee; z-index: 50; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 0.65rem; font-weight: bold; color: #adb5bd; cursor: pointer; }
        .active { color: #3498db; }
    </style>
</head>
<body oncontextmenu="return false;"> <div id="ui-top">
        <div id="score-container"><span id="coins">0</span>üíµ</div>
        <div id="power-info">–°–∏–ª–∞: <span id="current-power">1</span> / 5</div>
        <div id="user-info" onclick="changeName()">–ù–∏–∫: <span id="display-name">...</span></div>
    </div>

    <div id="game-area">
        <img id="click-btn" src="gerb.png" alt="Tap" draggable="false">
    </div>

    <div id="modal-top" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModals()">√ó</span>
            <h2>üë• –¢–û–ü –ò–ì–†–û–ö–û–í</h2>
            <div id="lb-content">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
    </div>

    <div id="modal-chat" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModals()">√ó</span>
            <h2>üí¨ –ß–ê–¢</h2>
            <div id="chat-content">...</div>
            <div style="display:flex; gap:5px; margin-top:10px;">
                <input type="text" id="chat-input" style="flex:1; padding:10px; border-radius:10px; border:1px solid #ddd;">
                <button onclick="sendMsg()" style="padding:10px; border-radius:10px; background:#3498db; color:white; border:none;">‚û§</button>
            </div>
        </div>
    </div>

    <nav>
        <div class="nav-item active" id="nav-home" onclick="closeModals()">üè†<br>–ì–õ–ê–í–ù–ê–Ø</div>
        <div class="nav-item" id="nav-top" onclick="openModal('modal-top')">üë•<br>–¢–û–ü</div>
        <div class="nav-item" id="nav-chat" onclick="openModal('modal-chat')">üí¨<br>–ß–ê–¢</div>
        <div class="nav-item" onclick="buyBoost()" style="color: #f39c12;">‚ö°<br><b id="boost-label">100</b></div>
    </nav>

    <script>
        const DB_URL = "https://clikercomee-default-rtdb.firebaseio.com"; 
        let userName = localStorage.getItem('p_name') || prompt("–ù–∏–∫:") || "User" + Math.floor(Math.random()*100);
        localStorage.setItem('p_name', userName);
        
        let count = parseInt(localStorage.getItem('p_coins')) || 0;
        let power = parseInt(localStorage.getItem('p_power')) || 1;
        const boostPrices = [0, 100, 500, 1000, 1500, 2000];

        function updateUI() {
            document.getElementById('coins').innerText = count.toLocaleString();
            document.getElementById('current-power').innerText = power;
            document.getElementById('display-name').innerText = userName;
            document.getElementById('boost-label').innerText = power >= 5 ? "MAX" : boostPrices[power];
        }

        async function sync() { 
            await fetch(`${DB_URL}/players/${userName}.json`, { method: 'PUT', body: JSON.stringify({ score: count, power: power }) }); 
        }

        async function fetchServerData() {
            try {
                const res = await fetch(`${DB_URL}/players/${userName}.json`);
                const data = await res.json();
                if (data) {
                    if (data.score !== count || data.power !== power) {
                        count = data.score || 0; power = data.power || 1;
                        updateUI();
                    }
                }
            } catch(e) {}
        }

        document.getElementById('click-btn').onclick = (e) => {
            e.preventDefault(); // –ó–∞—â–∏—Ç–∞ –æ—Ç –ª–∏—à–Ω–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π –±—Ä–∞—É–∑–µ—Ä–∞
            count += power; updateUI(); sync();
            const btn = document.getElementById('click-btn');
            btn.classList.remove('shake-anim'); void btn.offsetWidth; btn.classList.add('shake-anim');
        };

        function buyBoost() {
            if (power >= 5) return;
            let cost = boostPrices[power];
            if (count >= cost) { count -= cost; power++; updateUI(); sync(); } else { alert("–ú–∞–ª–æ –º–æ–Ω–µ—Ç!"); }
        }

        async function loadLB() {
            try {
                const res = await fetch(`${DB_URL}/players.json`);
                const data = await res.json();
                const box = document.getElementById('lb-content');
                box.innerHTML = '';
                if (!data) return;
                
                // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –∑–∞–±–∏—Ä–∞–µ–º score –∏ power –Ω–∞–ø—Ä—è–º—É—é –∏–∑ –æ–±—ä–µ–∫—Ç–æ–≤ –∏–≥—Ä–æ–∫–æ–≤
                const sorted = Object.entries(data).sort((a,b) => (b[1].score || 0) - (a[1].score || 0)).slice(0, 20);
                
                sorted.forEach((p, i) => {
                    const pName = p[0];
                    const pScore = p[1].score || 0;
                    const pPower = p[1].power || 1; // –í–æ—Ç –∑–¥–µ—Å—å —Ç–µ–ø–µ—Ä—å –±–µ—Ä–µ—Ç—Å—è –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –ª–≤–ª
                    
                    box.innerHTML += `
                        <div class="player-row" style="${pName === userName ? 'border: 2px solid #3498db;' : ''}">
                            <span><b>${i+1}.</b> ${pName} <br> <small>–°–∏–ª–∞: ${pPower}</small></span>
                            <b>${pScore.toLocaleString()} üíµ</b>
                        </div>`;
                });
            } catch(e) { console.error("–û—à–∏–±–∫–∞ –¢–û–ü–∞"); }
        }

        async function sendMsg() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text) return;
            input.value = '';
            await fetch(`${DB_URL}/chat.json`, { method: 'POST', body: JSON.stringify({ user: userName, msg: text, time: Date.now() }) });
            loadChat();
        }

        async function loadChat() {
            const res = await fetch(`${DB_URL}/chat.json`);
            const data = await res.json();
            const box = document.getElementById('chat-content');
            if (!data) return;
            box.innerHTML = '';
            Object.values(data).sort((a,b) => a.time - b.time).forEach(m => {
                box.innerHTML += `<div class="msg ${m.user === userName ? 'my' : ''}"><b>${m.user}</b>${m.msg}</div>`;
            });
            box.scrollTop = box.scrollHeight;
        }

        function openModal(id) { 
            closeModals();
            document.getElementById(id).style.display = 'flex'; 
            if(id === 'modal-top') loadLB(); 
            if(id === 'modal-chat') loadChat();
        }

        function closeModals() { 
            document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); 
            updateUI(); 
        }

        function changeName() {
            let n = prompt("–ù–æ–≤—ã–π –Ω–∏–∫:", userName);
            if(n) { userName = n; localStorage.setItem('p_name', n); updateUI(); sync(); }
        }

        updateUI();
        setInterval(fetchServerData, 3000);
        setInterval(() => { if(document.getElementById('modal-top').style.display === 'flex') loadLB(); }, 5000);
    </script>
</body>
</html>
