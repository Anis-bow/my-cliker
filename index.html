<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>bachoi 17 maktab</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f4f8; margin: 0; display: flex; flex-direction: column; align-items: center; height: 100vh; overflow: hidden; }
        #ui-top { text-align: center; margin-top: 20px; z-index: 10; width: 100%; }
        #score-container { font-size: 3.5rem; font-weight: 900; color: #2c3e50; line-height: 1; }
        #power-info { font-size: 1rem; color: #7f8c8d; margin-top: 5px; font-weight: bold; }
        #user-info { margin-top: 10px; font-size: 0.9rem; color: #3498db; cursor: pointer; text-decoration: underline; }

        #game-area { flex: 1; display: flex; align-items: center; justify-content: center; width: 100%; }
        #click-btn { width: 220px; height: 220px; border-radius: 50%; border: 8px solid white; box-shadow: 0 15px 35px rgba(0,0,0,0.1); cursor: pointer; object-fit: cover; transition: transform 0.05s; }
        
        @keyframes shake { 0% { transform: scale(1); } 50% { transform: scale(0.92); } 100% { transform: scale(1); } }
        .shake-anim { animation: shake 0.1s; }

        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 100; backdrop-filter: blur(4px); }
        .modal-content { background: white; width: 90%; max-width: 400px; border-radius: 25px; padding: 20px; position: relative; max-height: 80vh; display: flex; flex-direction: column; overflow-y: auto; }
        .close-btn { position: absolute; top: 15px; right: 20px; font-size: 1.8rem; cursor: pointer; color: #ccc; z-index: 10; }
        
        /* –°–µ—Ç–∫–∞ –º–∞–≥–∞–∑–∏–Ω–∞ */
        .shop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 10px; }
        .shop-item { background: #f8f9fa; padding: 10px; border-radius: 15px; text-align: center; border: 1px solid #eee; }
        .shop-item img { width: 60px; height: 60px; object-fit: contain; margin-bottom: 5px; }
        .shop-item h4 { margin: 5px 0; font-size: 0.9rem; }
        .shop-item p { margin: 0 0 10px; color: #e67e22; font-weight: bold; font-size: 0.8rem; }
        .buy-btn { background: #27ae60; color: white; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 0.8rem; width: 100%; }

        .player-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; align-items: center; }
        .lvl-badge { background: #f39c12; color: white; padding: 2px 6px; border-radius: 5px; font-size: 0.7rem; margin-left: 5px; }
        
        nav { position: fixed; bottom: 0; width: 100%; height: 75px; background: white; display: flex; border-top: 1px solid #eee; z-index: 50; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: bold; color: #adb5bd; cursor: pointer; }
        .active { color: #3498db; }
    </style>
</head>
<body>

    <div id="ui-top">
        <div id="score-container"><span id="coins">0</span>üíµ</div>
        <div id="power-info">–°–∏–ª–∞: <span id="current-power">1</span></div>
        <div id="user-info" onclick="changeName()">–ù–∏–∫: <span id="display-name">...</span> (–∏–∑–º–µ–Ω–∏—Ç—å)</div>
    </div>

    <div id="game-area">
        <img id="click-btn" src="gerb.png" alt="Tap">
    </div>

    <div id="modal-top" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModals()">√ó</span>
            <h2>üë• –¢–û–ü –ò–ì–†–û–ö–û–í</h2>
            <div id="lb-content">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
    </div>

    <div id="modal-shop" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModals()">√ó</span>
            <h2>üéÅ –û–ë–ú–ï–ù –ü–û–î–ê–†–ö–û–í</h2>
            <div class="shop-grid">
                <div class="shop-item">
                    <img src="https://cdn-icons-png.flaticon.com/512/2589/2589175.png">
                    <h4>–°–µ—Ä–¥–µ—á–∫–æ</h4><p>20,000 üíµ</p>
                    <button class="buy-btn" onclick="exchangeGift('–°–µ—Ä–¥–µ—á–∫–æ', 20000)">–û–±–º–µ–Ω—è—Ç—å</button>
                </div>
                <div class="shop-item">
                    <img src="https://cdn-icons-png.flaticon.com/512/3069/3069172.png">
                    <h4>–ú–∏—à–∫–∞</h4><p>20,000 üíµ</p>
                    <button class="buy-btn" onclick="exchangeGift('–ú–∏—à–∫–∞', 20000)">–û–±–º–µ–Ω—è—Ç—å</button>
                </div>
                <div class="shop-item">
                    <img src="https://cdn-icons-png.flaticon.com/512/3405/3405777.png">
                    <h4>–†–æ–∑–∞</h4><p>35,000 üíµ</p>
                    <button class="buy-btn" onclick="exchangeGift('–†–æ–∑–∞', 35000)">–û–±–º–µ–Ω—è—Ç—å</button>
                </div>
                <div class="shop-item">
                    <img src="https://cdn-icons-png.flaticon.com/512/4213/4213958.png">
                    <h4>–ü–æ–¥–∞—Ä–æ–∫</h4><p>35,000 üíµ</p>
                    <button class="buy-btn" onclick="exchangeGift('–ü–æ–¥–∞—Ä–æ–∫', 35000)">–û–±–º–µ–Ω—è—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <nav>
        <div class="nav-item active" onclick="closeModals()">üè†<br>–ì–õ–ê–í–ù–ê–Ø</div>
        <div class="nav-item" onclick="openModal('modal-top')">üë•<br>–ò–ì–†–û–ö–ò</div>
        <div class="nav-item" onclick="openModal('modal-shop')">üéÅ<br>–û–ë–ú–ï–ù</div>
        <div class="nav-item" onclick="buyBoost()" style="color: #f39c12;">‚ö°<br><b id="boost-label">100</b></div>
    </nav>

    <script>
        const DB_URL = "https://clikercomee-default-rtdb.firebaseio.com"; 
        let userName = localStorage.getItem('p_name') || prompt("–¢–≤–æ–π –Ω–∏–∫:") || "User" + Math.floor(Math.random()*100);
        localStorage.setItem('p_name', userName);
        
        let count = parseInt(localStorage.getItem('p_coins')) || 0;
        let power = parseInt(localStorage.getItem('p_power')) || 1;

        function updateUI() {
            document.getElementById('coins').innerText = count.toLocaleString();
            document.getElementById('current-power').innerText = power;
            document.getElementById('display-name').innerText = userName;
            document.getElementById('boost-label').innerText = Math.pow(2, power - 1) * 100;
        }

        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è: –û–¢–ü–†–ê–í–ò–¢–¨
        async function sync() { 
            await fetch(`${DB_URL}/players/${userName}.json`, { 
                method: 'PUT', 
                body: JSON.stringify({ score: count, power: power }) 
            }); 
        }

        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è: –ü–û–õ–£–ß–ò–¢–¨ (—á—Ç–æ–±—ã —á–∏—Å–ª–∞ —Å–æ–≤–ø–∞–¥–∞–ª–∏ –≤–µ–∑–¥–µ)
        async function fetchServerData() {
            try {
                const res = await fetch(`${DB_URL}/players/${userName}.json`);
                const data = await res.json();
                if (data && data.score !== undefined) {
                    // –ï—Å–ª–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ —á–∏—Å–ª–æ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç —Ç–æ–≥–æ —á—Ç–æ –Ω–∞ —ç–∫—Ä–∞–Ω–µ - –∏—Å–ø—Ä–∞–≤–ª—è–µ–º
                    if (data.score !== count) {
                        count = data.score;
                        power = data.power || power;
                        updateUI();
                        localStorage.setItem('p_coins', count);
                        localStorage.setItem('p_power', power);
                    }
                }
            } catch(e) {}
        }

        document.getElementById('click-btn').onclick = () => {
            count += power;
            updateUI();
            localStorage.setItem('p_coins', count);
            const btn = document.getElementById('click-btn');
            btn.classList.remove('shake-anim'); void btn.offsetWidth; btn.classList.add('shake-anim');
            sync();
        };

        function buyBoost() {
            let cost = Math.pow(2, power - 1) * 100;
            if (count >= cost) {
                count -= cost; power++; updateUI();
                localStorage.setItem('p_coins', count); localStorage.setItem('p_power', power);
                sync();
            } else { alert("–ú–∞–ª–æ –º–æ–Ω–µ—Ç!"); }
        }

        async function exchangeGift(name, price) {
            if (count < price) { alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç!"); return; }
            let tg = prompt("–¢–≤–æ–π Telegram (@nick):");
            if (!tg) return;
            count -= price; updateUI(); sync();
            await fetch(`${DB_URL}/orders.json`, { method: 'POST', body: JSON.stringify({user: userName, tg: tg, gift: name, time: Date.now()}) });
            alert("–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞! –ê–¥–º–∏–Ω —Å–≤—è–∂–µ—Ç—Å—è.");
        }

        function openModal(id) { 
            closeModals();
            document.getElementById(id).style.display = 'flex'; 
            if(id === 'modal-top') loadLB(); 
        }

        function closeModals() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); updateUI(); }

        function changeName() {
            let n = prompt("–ù–æ–≤—ã–π –Ω–∏–∫:", userName);
            if(n) { userName = n; localStorage.setItem('p_name', n); updateUI(); sync(); }
        }

        async function loadLB() {
            const res = await fetch(`${DB_URL}/players.json`);
            const data = await res.json();
            const box = document.getElementById('lb-content');
            box.innerHTML = '';
            if(!data) return;
            const sorted = Object.entries(data).sort((a,b)=>b[1].score-a[1].score).slice(0,15);
            sorted.forEach((p, i) => {
                box.innerHTML += `<div class="player-row" style="${p[0]===userName?'color:#3498db;font-weight:bold':''}">
                    <span>${i+1}. ${p[0]} <span class="lvl-badge">LVL ${p[1].power||1}</span></span>
                    <b>${p[1].score.toLocaleString()} üíµ</b></div>`;
            });
        }

        updateUI();
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–µ—Ä–≤–µ—Ä –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏
        setInterval(fetchServerData, 2000); 
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É –ª–∏–¥–µ—Ä–æ–≤ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫
        setInterval(() => {
            if(document.getElementById('modal-top').style.display === 'flex') loadLB();
        }, 5000);
    </script>
</body>
</html>
